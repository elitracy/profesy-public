{"version":3,"sources":["../../../src/commands/eject/prebuildAppAsync.ts"],"names":["prebuildAsync","projectRoot","platforms","options","exp","pkg","tempDir","temporary","directory","hasNewProjectFiles","needsPodInstall","hasNewDependencies","template","undefined","skipDependencyUpdate","shouldInstall","install","packageManager","CreateApp","resolvePackageManager","npm","yarn","clean","configSyncingStep","managedConfig","succeed","error","fail","podsInstalled","includes","installCocoaPodsAsync","Log","debug","sdkVersion","Object","keys","_internal","pluginHistory","nodeInstall","podInstall","legacyUpdates","hasAssetBundlePatterns","hasOwnProperty"],"mappings":"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","sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport { ModPlatform } from '@expo/config-plugins';\nimport temporary from 'tempy';\n\nimport Log from '../../log';\nimport { logNewSection } from '../../utils/ora';\nimport * as CreateApp from '../utils/CreateApp';\nimport { usesOldExpoUpdatesAsync } from '../utils/ProjectUtils';\nimport configureProjectAsync from './configureProjectAsync';\nimport { createNativeProjectsFromTemplateAsync } from './createNativeProjectsFromTemplateAsync';\nimport { ensureConfigAsync } from './ensureConfigAsync';\nimport { installNodeDependenciesAsync } from './installNodeDependenciesAsync';\nimport { assertPlatforms, ensureValidPlatforms } from './platformOptions';\nimport { resolveTemplateOption } from './resolveTemplate';\nimport { warnIfDependenciesRequireAdditionalSetup } from './setupWarnings';\n\nexport type EjectAsyncOptions = {\n  verbose?: boolean;\n  force?: boolean;\n  template?: string;\n  install?: boolean;\n  packageManager?: 'npm' | 'yarn';\n  platforms: ModPlatform[];\n  skipDependencyUpdate?: string[];\n};\n\nexport type PrebuildResults = {\n  hasAssetBundlePatterns: boolean;\n  legacyUpdates: boolean;\n  hasNewProjectFiles: boolean;\n  platforms: ModPlatform[];\n  podInstall: boolean;\n  nodeInstall: boolean;\n  packageManager: string;\n};\n\n/**\n * Entry point into the prebuild process, delegates to other helpers to perform various steps.\n *\n * 1. Create native projects (ios, android)\n * 2. Install node modules\n * 3. Apply config to native projects\n * 4. Install CocoaPods\n */\nexport async function prebuildAsync(\n  projectRoot: string,\n  { platforms, ...options }: EjectAsyncOptions\n): Promise<PrebuildResults> {\n  platforms = ensureValidPlatforms(platforms);\n  assertPlatforms(platforms);\n\n  const { exp, pkg } = await ensureConfigAsync({ projectRoot, platforms });\n  const tempDir = temporary.directory();\n\n  const {\n    hasNewProjectFiles,\n    needsPodInstall,\n    hasNewDependencies,\n  } = await createNativeProjectsFromTemplateAsync({\n    projectRoot,\n    exp,\n    pkg,\n    template: options.template != null ? resolveTemplateOption(options.template) : undefined,\n    tempDir,\n    platforms,\n    skipDependencyUpdate: options.skipDependencyUpdate,\n  });\n\n  // Install node modules\n  const shouldInstall = options?.install !== false;\n\n  const packageManager = CreateApp.resolvePackageManager({\n    install: shouldInstall,\n    npm: options?.packageManager === 'npm',\n    yarn: options?.packageManager === 'yarn',\n  });\n\n  if (shouldInstall) {\n    await installNodeDependenciesAsync(projectRoot, packageManager, {\n      // We delete the dependencies when new ones are added because native packages are more fragile.\n      // npm doesn't work well so we always run the cleaning step when npm is used in favor of yarn.\n      clean: hasNewDependencies || packageManager === 'npm',\n    });\n  }\n\n  // Apply Expo config to native projects\n  const configSyncingStep = logNewSection('Config syncing');\n  let managedConfig: ExpoConfig;\n  try {\n    managedConfig = await configureProjectAsync({\n      projectRoot,\n      platforms,\n    });\n    configSyncingStep.succeed('Config synced');\n  } catch (error) {\n    configSyncingStep.fail('Config sync failed');\n    throw error;\n  }\n\n  // Install CocoaPods\n  let podsInstalled: boolean = false;\n  // err towards running pod install less because it's slow and users can easily run npx pod-install afterwards.\n  if (platforms.includes('ios') && shouldInstall && needsPodInstall) {\n    podsInstalled = await CreateApp.installCocoaPodsAsync(projectRoot);\n  } else {\n    Log.debug('Skipped pod install');\n  }\n\n  warnIfDependenciesRequireAdditionalSetup(\n    pkg,\n    exp.sdkVersion,\n    Object.keys(managedConfig._internal?.pluginHistory ?? {})\n  );\n\n  return {\n    packageManager,\n    nodeInstall: options.install === false,\n    podInstall: !podsInstalled,\n    legacyUpdates: await usesOldExpoUpdatesAsync(projectRoot),\n    platforms,\n    hasNewProjectFiles,\n    hasAssetBundlePatterns: exp.hasOwnProperty('assetBundlePatterns'),\n  };\n}\n"],"file":"prebuildAppAsync.js"}