{"version":3,"sources":["../../../src/commands/utils/bundledNativeModules.ts"],"names":["getBundledNativeModulesAsync","projectRoot","sdkVersion","getBundledNativeModulesFromExpoPackageAsync","getBundledNativeModulesFromApiAsync","Log","warn","chalk","bold","client","ApiV2","clientForUser","list","getAsync","length","Error","fromBundledNativeModuleList","bundledNativeModulesPath","resolveFrom","silent","addNewLineIfNone","CommandError","JsonFile","readAsync","reduce","acc","i","npmPackage","versionRange"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,eAAeA,4BAAf,CACLC,WADK,EAELC,UAFK,EAG0B;AAC/B,MAAIA,UAAU,KAAK,aAAnB,EAAkC;AAChC,WAAO,MAAMC,2CAA2C,CAACF,WAAD,CAAxD;AACD,GAFD,MAEO;AACL,QAAI;AACF,aAAO,MAAMG,mCAAmC,CAACF,UAAD,CAAhD;AACD,KAFD,CAEE,MAAM;AACNG,qBAAIC,IAAJ,CACG,kFAAiFD,eAAIE,KAAJ,CAAUC,IAAV,CAChF,2BADgF,CAEhF,uBAAsBH,eAAIE,KAAJ,CAAUC,IAAK,MAAM,8BAH/C;;AAKA,aAAO,MAAML,2CAA2C,CAACF,WAAD,CAAxD;AACD;AACF;AACF;;AAED,eAAeG,mCAAf,CACEF,UADF,EAEiC;AAC/B,QAAMO,MAAM,GAAGC,aAAMC,aAAN,EAAf;AACA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACE,QAAMC,IAAI,GAAG,MAAMH,MAAM,CAACI,QAAP,CAAiB,QAAOX,UAAW,iBAAnC,CAAnB;;AACA,MAAIU,IAAI,CAACE,MAAL,KAAgB,CAApB,EAAuB;AACrB,UAAM,IAAIC,KAAJ,CAAU,kDAAV,CAAN;AACD;;AACD,SAAOC,2BAA2B,CAACJ,IAAD,CAAlC;AACD;AAED;AACA;AACA;AACA;;;AACA,eAAeT,2CAAf,CACEF,WADF,EAEiC;AAC/B,QAAMgB,wBAAwB,GAAGC,uBAAYC,MAAZ,CAC/BlB,WAD+B,EAE/B,gCAF+B,CAAjC;;AAIA,MAAI,CAACgB,wBAAL,EAA+B;AAC7BZ,mBAAIe,gBAAJ;;AACA,UAAM,KAAIC,uBAAJ,EACH,sBAAqBhB,eAAIE,KAAJ,CAAUC,IAAV,CACnB,gCADmB,CAEpB,yDAAwDH,eAAIE,KAAJ,CACvDC,IAAK,MAAM,gCAJV,CAAN;AAMD;;AACD,SAAO,MAAMc,oBAASC,SAAT,CAAyCN,wBAAzC,CAAb;AACD;;AAED,SAASD,2BAAT,CAAqCJ,IAArC,EAA0F;AACxF,SAAOA,IAAI,CAACY,MAAL,CAAY,CAACC,GAAD,EAAMC,CAAN,KAAY;AAC7BD,IAAAA,GAAG,CAACC,CAAC,CAACC,UAAH,CAAH,GAAoBD,CAAC,CAACE,YAAtB;AACA,WAAOH,GAAP;AACD,GAHM,EAGJ,EAHI,CAAP;AAID","sourcesContent":["import JsonFile from '@expo/json-file';\nimport resolveFrom from 'resolve-from';\nimport { ApiV2 } from 'xdl';\n\nimport CommandError from '../../CommandError';\nimport Log from '../../log';\n\ninterface NativeModule {\n  npmPackage: string;\n  versionRange: string;\n}\ntype BundledNativeModuleList = NativeModule[];\nexport type BundledNativeModules = Record<string, string>;\n\n/**\n * Gets the bundledNativeModules.json for a given SDK version:\n * - Tries to fetch the data from the /sdks/:sdkVersion/native-modules API endpoint.\n * - If the data is missing on the server (it can happen for SDKs that are yet fully released)\n *    or there's a downtime, reads the local .json file from the \"expo\" package.\n * - For UNVERSIONED, returns the local .json file contents.\n */\nexport async function getBundledNativeModulesAsync(\n  projectRoot: string,\n  sdkVersion: string\n): Promise<BundledNativeModules> {\n  if (sdkVersion === 'UNVERSIONED') {\n    return await getBundledNativeModulesFromExpoPackageAsync(projectRoot);\n  } else {\n    try {\n      return await getBundledNativeModulesFromApiAsync(sdkVersion);\n    } catch {\n      Log.warn(\n        `Unable to reach Expo servers. Falling back to using the cached dependency map (${Log.chalk.bold(\n          'bundledNativeModules.json'\n        )}) from the package \"${Log.chalk.bold`expo`}\" installed in your project.`\n      );\n      return await getBundledNativeModulesFromExpoPackageAsync(projectRoot);\n    }\n  }\n}\n\nasync function getBundledNativeModulesFromApiAsync(\n  sdkVersion: string\n): Promise<BundledNativeModules> {\n  const client = ApiV2.clientForUser();\n  /**\n   * The endpoint returns the list of bundled native modules for a given SDK version.\n   * The data is populated by the `et sync-bundled-native-modules` script from expo/expo repo.\n   * See the code for more details:\n   * https://github.com/expo/expo/blob/master/tools/src/commands/SyncBundledNativeModules.ts\n   *\n   * Example result:\n   * [\n   *   {\n   *     id: \"79285187-e5c4-47f7-b6a9-664f5d16f0db\",\n   *     sdkVersion: \"41.0.0\",\n   *     npmPackage: \"expo-analytics-amplitude\",\n   *     versionRange: \"~10.1.0\",\n   *     createdAt: \"2021-04-29T09:34:32.825Z\",\n   *     updatedAt: \"2021-04-29T09:34:32.825Z\"\n   *   },\n   *   ...\n   * ]\n   */\n  const list = await client.getAsync(`sdks/${sdkVersion}/native-modules`);\n  if (list.length === 0) {\n    throw new Error('The bundled native module list from www is empty');\n  }\n  return fromBundledNativeModuleList(list);\n}\n\n/**\n * Get the legacy static `bundledNativeModules.json` file\n * that's shipped with the version of `expo` that the project has installed.\n */\nasync function getBundledNativeModulesFromExpoPackageAsync(\n  projectRoot: string\n): Promise<BundledNativeModules> {\n  const bundledNativeModulesPath = resolveFrom.silent(\n    projectRoot,\n    'expo/bundledNativeModules.json'\n  );\n  if (!bundledNativeModulesPath) {\n    Log.addNewLineIfNone();\n    throw new CommandError(\n      `The dependency map ${Log.chalk.bold(\n        `expo/bundledNativeModules.json`\n      )} cannot be found, please ensure you have the package \"${Log.chalk\n        .bold`expo`}\" installed in your project.\\n`\n    );\n  }\n  return await JsonFile.readAsync<BundledNativeModules>(bundledNativeModulesPath);\n}\n\nfunction fromBundledNativeModuleList(list: BundledNativeModuleList): BundledNativeModules {\n  return list.reduce((acc, i) => {\n    acc[i.npmPackage] = i.versionRange;\n    return acc;\n  }, {} as BundledNativeModules);\n}\n"],"file":"bundledNativeModules.js"}